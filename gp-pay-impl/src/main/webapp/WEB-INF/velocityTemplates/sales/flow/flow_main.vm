<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>查询流向&nbsp; - &nbsp;
        #if(!$null.isNull($title))
            $!{title}
        #end
    </title>

    <!-- mypharma_公共资源 -->
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

    <link rel="stylesheet" type="text/css" href="/js/layui/css/layui.css">
    <!-- mypharma_样式 -->
    <link rel="stylesheet" type="text/css" href="/css/global-old.css">
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    <link rel="stylesheet" type="text/css" href="/css/order.css">

    <link rel="stylesheet" type="text/css" href="/css/new_order.css">
    <link rel="stylesheet" type="text/css" href="/css/new_dialog.css">
    <link rel="stylesheet" type="text/css" href="/css/dialog.css">
    <link rel="stylesheet" type="text/css" href="/css/hm.css">

    <!--PNG格式图片兼容IE6解决方案 -->
    <!--[if IE 6]>
    <script type="text/javascript" src="/js/DD_belatedPNG_0.0.8a-min.js"></script>
    <script type="text/javascript">
        DD_belatedPNG.fix('*');
    </script>
    <![endif]-->
</head>

<body>
<div class="container">
    <div class="hm-header">
        <div class="wrap cc">
            <div class="h-logo">
                #if(!$null.isNull($logo))
                    <a onclick="return false;" href="javascript:void(0);"><img src="$!{logo}"></a>
                #end
            </div>
            <div class="h-title">
                #if(!$null.isNull($title))
                    $!{title}
                #end
            </div>
        </div>
    </div>
    <div class="content">
        <div class="wrap cc">
            <div class="leftmenu hm-leftmenu fl">
                <div class="cnt">
                    <dl>
                    ##                        <dt>流向查询</dt>
                        <dd>
                            <a class="on" href="javascript:void(0);">查询流向</a>
                        </dd>
                        <dd>
                            <a class="" href="/sales/flow/account_main.html">账号管理</a>
                        </dd>
                        <dd>
                            <a class="" href="/sales/flow/searchERP_main.html">商业公司ERP对接情况</a>
                        </dd>
                    </dl>
                </div>
            </div>
            <div class="user_right fl">
                <div class="hm-search-box">

                    <div class="hsb-header">
                        <h3 class="hsb-h-title">我的搜索</h3>
                    </div>

                    <div class="hsb-ctn">
                        <ul>
                            #if(!$null.isNull($conditions) && $conditions.size()!=0)
                                #foreach($condition in $!conditions)
                                    <li>
                                        <span onclick="backFill($!{condition.qcId},this)" class="text" title="$!{condition.qcName}-$!{condition.qcCount}">$!{condition.qcName}-$!{condition.qcCount}</span>
                                        <a href="javascript:void(0);" onclick="rmQuery($!{condition.qcId},null,this)" class="btn-remove layer-search-btn"></a>
                                    </li>
                                #end
                            #end
                        </ul>
                    </div>

                </div>
                <div class="hm-query-box">
                    <form id="form" name="form" method="post" >
                        <input type="hidden" name="start_date">
                        <input type="hidden" name="end_date">
                        <input type="hidden" name="paramJson">
                        <input type="hidden" name="timeType">
                        <input type="hidden" id="sid" name="sid" value="$!{sid}">
                    </form>
                    <table class="hqb-table" border="0" cellpadding="0" cellspacing="0" id= "table">
                        <tr>
                            <td class="tac" width="85">商业公司</td>
                            <td width="auto">
                                <div class="hm-choice-box fl hm-choice-province">
                                    <ul>
                                        <li data-id="-1"><a onclick="return false;" href="javascript:void(0);">全部省</a></li>
                                    </ul>
                                </div>
                                <div class="hm-choice-box fl hm-choice-city">
                                    <ul>
                                    </ul>
                                </div>
                                <div class="hm-choice-box fl hm-choice-company">
                                    <ul>
                                    </ul>
                                </div>
                                <div class="hm-choice-btn fl com-btn-box">
                                    <a data-evt="add" class="btn" onclick="return false;" href="javascript:void(0);">&#62; 添加</a>
                                    <a data-evt="del" class="btn" onclick="return false;" href="javascript:void(0);">&#60; 删除</a>
                                </div>
                                <div class="hm-choice-box fl hm-choice-result result-list-box">
                                    <ul>
                                    </ul>
                                </div>
                            #*<div class="hm-choice-result-count fl">已添加：0</div>*#
                            </td>
                        </tr>
                        <tr>
                            <td class="tac">产品名称</td>
                            <td>
                                <div class="hm-choice-box fl hm-choice-goods single-list-box">
                                    <ul>
                                        <li data-id="-2" data-gName="全部商品（含原始数据）" data-gSpecifications=""><a onclick="return false;" href="javascript:void(0);">全部产品（含原始数据）</a></li>
                                    #*    <li data-id="-1" data-gName="全部商品" data-gSpecifications=""><a onclick="return false;" href="javascript:void(0);">全部产品</a></li>*#
                                       #if(!$null.isNull($goodsList) && $goodsList.size()!=0)
                                           #foreach($goods in $!goodsList)
                                               <li data-id="$!{goods.gId}" data-gName="$!{goods.gName}" data-gSpecifications="$!{goods.gSpecifications}"><a onclick="return false;" href="javascript:void(0);"><span class="text">$!{goods.gName}</span>$!{goods.gSpecifications}</a></li>
                                           #end
                                       #end
                                   </ul>
                               </div>
                               <div class="hm-choice-btn fl cp-btn-box">
                                   <a data-evt="add" class="btn" onclick="return false;" href="javascript:void(0);">&#62; 添加</a>
                                   <a data-evt="del" class="btn" onclick="return false;" href="javascript:void(0);">&#60; 删除</a>
                               </div>
                               <div class="hm-choice-box fl hm-choice-goods-result result-list-box">
                                   <ul>
                                   </ul>
                               </div>
                               <div class="hm-choice-goods-count fl">已添加：0</div>
                           </td>
                       </tr>
                       <tr>
                           <td class="tac">查询时间</td>
                           <td>
                               <form class="hm-form">
                                   <fieldset class="radios">
                                       <label for="radio-01" class="label_radio">
                                           <input type="radio" checked="" value="1" id="radio-01" name="timeType" />上个月
                                       </label>
                                       <label for="radio-02" class="label_radio">
                                           <input type="radio" value="2" id="radio-02" name="timeType" />上周
                                       </label>
                                       <label for="radio-03" class="label_radio">
                                           <input type="radio" value="3" id="radio-03" name="timeType" />本月
                                       </label>
                                       <label for="radio-04" class="label_radio">
                                           <input type="radio" value="4" id="radio-04" name="timeType" />前一天
                                       </label>
                                       <label for="radio-05" class="label_radio">
                                           <input type="radio" value="5" id="radio-05" name="timeType" />自定义
                                       </label>
                                   </fieldset>
                               </form>
                               <input type="hidden" class="input input-date" name="curdate" id="curdate" value="$!{curdate}">
                               <input class="input input-date fl" id="start_date" name="start_date" type="text" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',onpicking:function(dp){this.focus()},maxDate:'#F{$dp.$D(\'curdate\')}'})">
                               <i class="to">至</i>
                               <input class="input input-date fl" id="end_date" name="end_date" type="text" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',onpicking:function(dp){this.focus()},minDate:'#F{$dp.$D(\'start_date\')}',maxDate:'#F{$dp.$D(\'curdate\')}'})">
                           </td>
                       </tr>
                       <tr>
                           <td class="tac">流向信息类型</td>
                           <td>
                               <form class="hm-form">
                                   <fieldset class="checkboxes">
                                       <label for="checkbox-01" class="label_radio" >
                                           <input type="radio" checked value="1" id="checkbox-01" name="qcDownloadType"/>总表
                                       </label>
                                       <label for="checkbox-02" class="label_radio" >
                                           <input type="radio" value="2" id="checkbox-02" name="qcDownloadType"/>按产品
                                       </label>
                                       <label for="checkbox-03" class="label_radio" >
                                           <input type="radio"  value="3" id="checkbox-03" name="qcDownloadType"/>按省
                                       </label>
                                   </fieldset>
                               </form>
                           </td>
                       </tr>
                   </table>
               </div>

               <div class="hm-btn-box">
                   <a class="btn btn-query ml10 layer-query-btn" onclick="downloadExc('1');" href="javascript:void(0);" >保存搜索</a>
                   <a class="btn btn-query ml10 layer-query-btn" id="downloadBtn" onclick="downloadExc('2');" href="javascript:void(0);" >查询并下载</a>
               </div>

               #*邮件订阅列表*#
                <div class="hm-email-box">

                    <div class="heb-header">
                        <h3 class="heb-h-title">邮箱订阅</h3>
                        <a class="heb-h-btn layer-add-mail-btn" href="javascript:void(0)">+ 新增邮箱订阅</a>
                    </div>

                    <table class="heb-table" border="0" cellpadding="0" cellspacing="0">
                        <thead>
                        <tr>
                            <th>编号</th>
                            <th >搜索名称</th>
                            <th >接收邮箱</th>
                            <th>发送计划</th>
                            <th>截止日期</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="emailListBox">
                        </tbody>
                    </table>
                </div>

                <div class="hm-page">

                </div>

                <!-- 用户中心_主体内容_E -->
            </div>
        </div>
    </div>
</div>

#*邮件列表 TPL*#
<script type="text/html" id="emailListTpl">
    {{# for(var i=0;i<d.length;i++){ var email = d[i]; }}
    <tr data-model='{{ JSON.stringify(email)}}'>
        <td>{{email.esId}}</td>
        <td style="width: 150px; word-break: break-all;">{{email.qcName}}</td>
        <td style="width: 510px;word-break: break-all;">{{email.esEmail}}</td>
        <td>
            {{# if(email.esSubType == 1){ }}
            每月 &nbsp; {{email.esSubDate}}号 &nbsp; {{email.esSubTime}}
            {{# }else if(email.esSubType == 2){ }}
            每周 &nbsp; {{getWeekDate(email.esSubDate)}} &nbsp; {{email.esSubTime}}
            {{# }else if(email.esSubType == 3){ }}
            每天 &nbsp; {{email.esSubTime}}
            {{# } }}
        </td>
        <td>{{ new Date(email.esEndTime).format('yyyy-MM-dd') }}</td>
        <td>
            <a href="javascript:;" class="t-link" onclick="Email.editEmail(this)">修改</a>
            <a href="javascript:;" class="t-link layer-delete-mail-btn" onclick='Email.delEmail({{email.esId}},{{JSON.stringify(email)}},this)'>删除</a>
        </td>
    </tr>
    {{# } }}
</script>

#*删除被使用搜索弹窗TPL*#
<script type="text/html" id="delConConfirmTpl">
    <div class="hm-dialog-box">
        <a href="javascript:;" class="btn-close layer-close-btn"></a>
        <div class="hdb-title">温馨提示</div>
        <div class="hdb-search-text" style="height: 90px; display: table; width: 90%;">
            <p style="display: table-cell; vertical-align: middle;  width: 100%">
                您正在删除”<i class="h">{{d.name}}</i>“搜索，有{{d.count}}个订阅（编号：{{d.msg}}）正在使用此搜索，请确认操作<br>
                <!--1.确定删除<i class="h">{{d.name}}</i>搜索，同时停用并删除 {{d.msg}} 号订阅<br>
                2.停止删除<i class="h">{{d.name}}</i>搜索-->
            </p>
        </div>
        <div class="hdb-btn">
            <a href="javascript:;" class="btn-confirm">确认</a>
            <a href="javascript:;" class="btn-cancel layer-close-btn">取消</a>
        </div>
    </div>
</script>

#*删除搜索确认弹窗TPL*#
<script type="text/html" id="delConfirm">
    <div class="hm-dialog-box ">
        <a href="javascript:;" class="btn-close layer-close-btn"></a>
        <div class="hdb-title">温馨提示</div>
        <div class="hdb-search-text" style="height: 90px; text-align: center; display: table; width: 100%; padding: 0">
            <p style="display: table-cell; vertical-align: middle; text-align: center; width: 100%">
                您正在删除”<i class="h">{{d.name}}</i>“搜索，请确认操作<br>
            </p>
        </div>
        <div class="hdb-btn">
            <a href="javascript:;" class="btn-confirm">确认</a>
            <a href="javascript:;" class="btn-cancel layer-close-btn">取消</a>
        </div>
    </div>
</script>

#*删除通用确认弹窗*#
<script type="text/html" id="delComConfirm">
    <div class="hm-dialog-box ">
        <a href="javascript:;" class="btn-close layer-close-btn"></a>
        <div class="hdb-title">温馨提示</div>
        <div class="hdb-search-text" style="height: 90px; text-align: center; display: table; width: 100%; padding: 0">
            <p style="display: table-cell; vertical-align: middle; text-align: center; width: 100%">
                {{d.text}}
            </p>
        </div>
        <div class="hdb-btn">
            <a href="javascript:;" class="btn-confirm">确认</a>
            <a href="javascript:;" class="btn-cancel layer-close-btn">取消</a>
        </div>
    </div>
</script>
#*删除邮件确认弹窗*#
<script type="text/html" id="delComConfirmEmail">
    <div class="hm-dialog-box ">
        <a href="javascript:;" class="btn-close layer-close-btn"></a>
        <div class="hdb-title">温馨提示</div>
        <div class="hdb-search-text">
            <table class="del-table">
                <tr>
                    <td colspan="2">您将要删除#{{d.esId}}号邮件订阅</td>
                </tr>
                <tr>
                    <td class="tb-label">创建于：</td>
                    <td>{{ new Date(d.createTime).format('yyyy-MM-dd') }}</td>
                </tr>
                <tr>
                    <td class="tb-label">接收邮件：</td>
                    <td  style="word-break: break-all; width: 315px;" >{{d.esEmail}}</td>
                </tr>
                <tr>
                    <td class="tb-label">发送计划：</td>
                    <td>
                        {{# if(d.esSubType == 1){ }}
                        每月 &nbsp; {{d.esSubDate}}号 &nbsp; {{d.esSubTime}}
                        {{# }else if(d.esSubType == 2){ }}
                        每周 &nbsp; {{getWeekDate(d.esSubDate)}} &nbsp; {{d.esSubTime}}
                        {{# }else if(d.esSubType == 3){ }}
                        每天 &nbsp; {{d.esSubTime}}
                        {{# } }}
                    </td>
                </tr>
                <tr>
                    <td colspan="2">删除后系统将不向订阅者发送邮件，确认吗？</td>
                </tr>
            </table>
        </div>
        <div class="hdb-btn">
            <a href="javascript:;" class="btn-confirm">确认</a>
            <a href="javascript:;" class="btn-cancel layer-close-btn">取消</a>
        </div>
    </div>
</script>

<script type="text/html" id="addEmailTpl">
    {{# var email = d; }}
    <div class="hm-dialog-h-box layer-add-mail-box" style="display: block;">
        <div class="hdhb-header">
            {{# if(email.option == "add"){ }}
            <h3 class="hdhb-h-title">新增邮箱订阅</h3>
            {{# }else{ }}
            <h3 class="hdhb-h-title">修改邮箱订阅</h3>
            {{# } }}
            <a href="javascript:;" class="btn-close layer-close-btn"></a>
        </div>
        <div class="hdhb-ctn">
            <form >
                <div class="table-scroll">
                    <table class="hdhb-c-table" border="0" cellpadding="0" cellspacing="0">
                        <tr>
                            <td class="tar" width="70">选择搜索：</td>
                            <td width="auto">
                                <select class="select" id="selSearchList" name="qcId" data-tips="请选择搜索项" data-value="{{email.qcId}}||{{email.qcName}}">
                                    <option value="">请选择搜索</option>
                                </select>
                            </td>
                        </tr>
                        {{# if(email.esEmail){ }}
                        {{# var es = email.esEmail.split(","); }}
                        {{# for(var i=0;i < es.length;i++){ }}
                        <tr class="rec-em-box">
                            <td class="tar">接收邮箱：</td>
                            <td>
                                <input name="esEmail"  class="input fl" type="text" value="{{es[i]}}" placeholder="xxx@qq.com" data-tips="请正确输入接收邮箱">
                            </td>
                        </tr>
                        {{# } }}
                        {{# }else{ }}
                        <tr class="rec-em-box">
                            <td class="tar">接收邮箱：</td>
                            <td>
                                <input name="esEmail"  class="input fl" type="text" placeholder="xxx@qq.com" data-tips="请正确输入接收邮箱">
                            </td>
                        </tr>
                        {{# } }}
                        <tr>
                            <td class="tar">发送计划：</td>
                            <td>
                                <select class="select select-date sl-time-type" name="esSubType" data-tips="请选择周期"  >
                                    <option value="">请选择</option>
                                    <option value="1" {{# if(email.esSubType == 1){ }}selected{{# } }}>每月</option>
                                    <option value="2" {{# if(email.esSubType == 2){ }}selected{{# } }}>每周</option>
                                    <option value="3" {{# if(email.esSubType == 3){ }}selected{{# } }}>每天</option>
                                </select>

                                <select class="select select-date sl-time-day" {{# if(email.esSubType == 3){ }}style="display:none;"{{# } }} name="esSubDate" data-tips="请选择计划日期" data-value="{{email.esSubDate}}">
                                    <option selected="" value="">请选择</option>
                                    {{# if(email.esSubType == 1){ }}
                                        {{# for(var i=1;i<29;i++){ }}
                                            {{# if(email.esSubDate == i){ }}
                                                <option selected value="{{i}}">{{i}}号</option>
                                            {{# }else{ }} <option value="{{i}}">{{i}}号</option> {{# } }}
                                        {{# } }}
                                    {{# } }}
                                    {{# if(email.esSubType == 2){ }}
                                        {{# var _week = ["一", "二", "三", "四", "五", "六", "日"]; }}
                                    {{# for(var i=1;i<8;i++){  }}
                                            {{# if(email.esSubDate == i){ }}
                                                <option selected value="{{i}}">星期{{_week[i-1]}}</option>
                                            {{# }else{ }}
                                                <option value="{{i}}">星期{{_week[i-1]}}</option>
                                            {{# } }}
                                        {{# } }}
                                    {{# } }}
                                </select>

                                <select class="select select-date" name="esSubTime" data-tips="请选择计划时间" data-value="{{email.esSubTime}}">
                                    <option selected="" value="">请选择</option>
                                    #set($foo = 0)
                                    #foreach($n in [0..47])
                                        #if($n%2 == 0)
                                            #if($foo < 9)
                                                <option value="0$!foo:00">0$!foo:00</option>
                                            #else
                                                <option value="$!foo:00">$!foo:00</option>
                                            #end
                                        #else
                                            #set($b=$foo)
                                            #if($b < 9)
                                                <option value="0$!b:30">0$!b:30</option>
                                            #else
                                                <option value="$!b:30">$!b:30</option>
                                            #end
                                            #set( $foo = $foo+1 )
                                        #end
                                    #end
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="tar">截止日期：</td>
                            <td>
                                {{# if(email.esEndTime){ }}
                                <input readonly value="{{ new Date(email.esEndTime).format('yyyy-MM-dd') }}" data-tips="请选择截止日期" class="input input-date fl" name="esEndTime" type="text" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',onpicking:function(dp){this.focus()},minDate:'%y-%M-%d'})">
                                {{# }else{  }}
                                <input readonly   data-tips="请选择截止日期" class="input input-date fl" name="esEndTime" type="text" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',onpicking:function(dp){this.focus()},minDate:'%y-%M-%d'})">
                                {{# } }}
                            </td>
                        </tr>
                    </table>
                </div>
            </form>
            <div class="hdhb-c-btn">
                <a href="javascript:;" class="btn-confirm">保存</a>
                <a href="javascript:;" class="btn-cancel layer-close-btn">取消</a>
            </div>
        </div>
    </div>
</script>

<div class="hm-dialog-h-box layer-save-search-box">
    <div class="hdhb-header">
        <h3 class="hdhb-h-title">搜索名称</h3>
        <a href="javascript:;" class="btn-close layer-close-btn"></a>
    </div>
    <div class="hdhb-ctn">
        <div class="hdhb-c-form">
            <input class="input" type="text" maxlength="15" placeholder="请输入搜索名称">
        </div>
        <div class="hdhb-c-error invisible">名字重复，换一个吧~</div>
        <div class="hdhb-c-btn">
            <a href="javascript:;" class="btn-confirm ">保存</a>
            <a href="javascript:;" class="btn-cancel layer-close-btn">取消</a>
        </div>
    </div>
</div>



#*<div class="hm-dialog-box layer-delete-mail-box">
    <a href="javascript:;" class="btn-close layer-close-btn"></a>
    <div class="hdb-title">温馨提示</div>
    <div class="hdb-search-text">
        您将要删除#3号邮件订阅：<br>
        <span class="fl">创 建 于：</span><i class="h text-r">2017年1月1日  12：33</i><br>
        <span class="fl">接收邮件：</span><i class="h text-r">chao.zhang@rograndec.com;  chao.zhang@rograndec.com;  chao.zhang@rograndec.com;</i><br>
        <span class="fl">发送计划：</span><i class="h text-r">每周一  9：00</i><br>
        删除后系统将不再向订阅者发送邮件，确认吗？
    </div>
    <div class="hdb-btn">
        <a href="javascript:;" class="btn-confirm ">确认</a>
        <a href="javascript:;" class="btn-cancel layer-close-btn">取消</a>
    </div>
</div>*#


<!-- 脚本 -->
<script src="/js/jquery-1.9.1.min.js?version=201612090950" type="text/javascript"></script>
<script src="/js/layui/layui.js"></script>
<script src="/js/publish.js"></script>
<script src="/js/pager.js" type="text/javascript"></script>
<script src="/js/pop_div.js" type="text/javascript"></script>
<script src="/js/extend.datetime.js" type="text/javascript"></script>
<script src="/js/jquery.json-2.2.js" type="text/javascript"></script>
<script src="/js/load.js"></script>
<script src="/js/dialog/dialog.js"></script>
    #parse("common/common_script.vm")
<script src="/js/public/My97DatePicker/WdatePicker.js"
        type="text/javascript"></script>
<script src="/js/enterpriseHelp.js" type="text/javascript"></script>
<script type="text/javascript" src="/js/layui/new-ui.js"></script>
<script type="text/javascript" src="/js/jquery.nicescroll.min.js"></script>
<script>

    var _backFillId = null , ps = 10 , Email = {} , timing = 30 , timerDownload;

    var laytpl, viewModal,layer,laypage,layFrom;
    layui.config({
        base:'/js/layui/extend/'
    }).use(["layer", "laytpl","laypage","form"], function () {
        laytpl = layui.laytpl,laypage = layui.laypage,layer = layui.layer,layFrom = layui.form();
        Email = {
            confirm:function (opts) {
                var _def = {
                    skin:""
                }
                opts = $.extend({},_def,opts);
                var _skin = 'scroll-no-bl dialog-hm-wrap '+ opts.skin;
                layer.open({
                    type: 1,
                    skin: _skin,
                    title: false,
                    closeBtn: 0,
                    area: ['510px'], //宽高
                    shadeClose: false, //开启遮罩关闭
                    content: opts.tpl,
                    success: function (lay, idx) {
                        if(opts.success) opts.success(lay,idx);
                        $(lay).find(".layer-close-btn").on("click", function () {
                            layer.close(idx);
                        })
                        lay.find(".btn-confirm").on("click", function () {
                            layer.close(idx);
                            if(opts.ok) opts.ok();
                        })
                    }
                })
            },
            ajax:function (opts) {
                var _def = {
                    data:{}
                }
                opts = $.extend({},_def,opts);
                layer.load(0,{shade:.1});
                $.ajax({
                    url: opts.url,
                    data: opts.data,
                    type:"POST",
                    complete:function () {
                        layer.closeAll("loading");
                    },
                    success: function(data) {
                        if(opts.success) opts.success(data);
                    },
                    error:function (err) {
                        if(opts.error) opts.error(err);
                    }
                });
            },
            openEmailModal:function (esData) {
                var _subUrl = '/sales/flow/addSubscription.html';
                var subData = {
                    option:"add",
                    esEmail: null,
                    esEndTime: null,
                    esId: null,
                    esLastExecuteTime: null,
                    esStatus: null,
                    esSubDate: null,
                    esSubTime: null,
                    esSubType: null,
                    qcId: null,
                    qcName: null,
                    suId: null,
                    uid: null
                };
                if(esData){
                    subData = $.extend({},subData,esData);
                    subData.option = "edit";
                    _subUrl = '/sales/flow/modifySubscription.html';
                }
                var _tpl = laytpl($("#addEmailTpl").html()).render(subData);
                layer.open({
                    type: 1,
                    skin: 'dialog-hm-wrap scroll-no-bl',
                    title: false,
                    closeBtn: 0,
                    area: ['455px'], //宽高
                    shadeClose: false, //开启遮罩关闭
                    content: _tpl,
                    success: function (lay, idx) {
                        var _defV = $("[name=esSubTime]").data("value");
                        if(_defV){
                            $("[name=esSubTime]").find("option").each(function (i,e) {
                                if($(this).val() == _defV){
                                    $(this).prop("selected",true);
                                }
                            })
                        }
                        $(".can-del").remove();
                        $(".table-scroll",lay).niceScroll({
                            /*autohidemode: false,*/  //是否总是显示
                            cursorcolor: "#bcd7e8"
                        });
                        $(lay).find(".layer-close-btn").on("click", function () {
                            layer.close(idx);
                        })
                        lay.find(".btn-confirm").on("click",function () {
                            //lay.find("form").submit();
                            var _data = lay.find("form").serializeArray();
                            var isOK = true;
                            var _json = {} , _arr = [];
                            $.each(_data,function (i,e) {
                                if(!e.value && $("[name="+e.name+"]").is(":visible")){
                                    layer.msg($("[name="+e.name+"]").attr("data-tips"));
                                    isOK = false;
                                    return false;
                                }else{
                                    if(e.name == "esEmail"){
                                        var _reg = /^(\w)+(\.\w+)*@(\w)+((\.\w{2,3}){1,3})$/;
                                        if(_reg.test(e.value)){
                                            if($.inArray(e.value,_arr) > -1){
                                                layer.msg("请不要输入同一个邮箱");
                                                isOK = false;
                                                return false;
                                            }else{
                                                _arr.push(e.value);
                                            }
                                        }else{
                                            layer.msg($("[name="+e.name+"]").attr("data-tips"));
                                            isOK = false;
                                            return false;
                                        }
                                    }
                                    else _json[e.name] = e.value;
                                }
                            })

                            if(isOK){
                                _json.esEmail = _arr.join(",");
                                _tmp = _json.qcId.split("||");
                                _json.qcName = _tmp[1];
                                _json.qcId = _tmp[0];

                                if(subData.option == "edit"){
                                    _json.esId = subData.esId;
                                }

                                layer.load(0,{shade:.1});
                                $.ajax({
                                    url:_subUrl,
                                    method:"POST",
                                    data:_json,
                                    complete:function () {
                                        layer.closeAll("loading");
                                    },
                                    success:function (res) {
                                        if(res && res.success){
                                            layer.close(idx);
                                            getEmailList(true,1);
                                            if(subData.option == "add"){
                                                layer.msg("新增邮件订阅成功");
                                            }else layer.msg("修改邮件订阅成功");
                                        }else{
                                            if(subData.option == "add"){
                                                layer.msg("新增邮件订阅失败");
                                            }else layer.msg("修改邮件订阅失败");
                                        }
                                    }
                                })
                            }
                        })
                        Email.ajax({
                            url:'/sales/flow/getConditions.html',
                            success:function (res) {
                                $("#selSearchList",lay).html("<option value=''>请选择搜索</option>");
                                var _defVal = $("#selSearchList",lay).data("value");
                                $.each(res.data,function (i,e) {
                                    if(_defVal && _defVal == (e.qcId+'||'+e.qcName)){
                                        $("#selSearchList",lay).append('<option selected value="'+e.qcId+'||'+e.qcName+'">'+e.qcName+'</option>');
                                    }else{
                                        $("#selSearchList",lay).append('<option value="'+e.qcId+'||'+e.qcName+'">'+e.qcName+'</option>');
                                    }
                                })
                            }
                        })

                        lay.find(".hdhb-c-table").unbind("click").on("click",".btn-add-mail,.btn-del-mail",function () {
                            var _tpl = '<tr  class="rec-em-box can-del">\n' +
                                    '                <td class="tar">接收邮箱：</td>\n' +
                                    '                <td>\n' +
                                    '                    <input name="esEmail"  class="input fl" type="text" placeholder="xxx@qq.com" data-tips="请正确输入接收邮箱">\n' +
                                    '                    <a class="btn-add-mail" href="javascript:;"></a>\n' +
                                    '                    <a class="btn-del-mail" href="javascript:;"></a>\n' +
                                    '                </td>\n' +
                                    '            </tr>';
                            var _h = $(this).closest("tr").outerHeight(true);
                            if($(this).hasClass("btn-add-mail")){//添加
                                $(_tpl).insertAfter($(this).closest("tr"));
                            }else{//删除
                                $(this).closest("tr").remove();
                            }
                            $(".table-scroll",lay).getNiceScroll().resize();
                            return false;
                        }).find(".sl-time-type").on("change",function () {
                            var _index = $(this).find("option:selected").index();
                            var _tpl = "";
                            $(".sl-time-day").find("option").not(":first").remove();
                            switch (_index){
                                case 1:
                                    $(".sl-time-day").show();
                                    var _defVal = $(".sl-time-day").data("value");
                                    for(var i=1;i<29;i++){
                                        if(i==_defVal){
                                            _tpl+='<option selected value="'+i+'">'+i+'号</option>';
                                        }else _tpl+='<option value="'+i+'">'+i+'号</option>';

                                    }
                                    break;
                                case 2:
                                    $(".sl-time-day").show();
                                    var _defVal = $(".sl-time-day").data("value");
                                    var _week = ["一", "二", "三", "四", "五", "六", "日"];
                                    for(var i=1;i<8;i++){
                                        if(i==_defVal){
                                            _tpl+='<option selected value="'+i+'">星期'+_week[i-1]+'</option>';
                                        }else _tpl+='<option value="'+i+'">星期'+_week[i-1]+'</option>';
                                    }
                                    break;
                                case 3:
                                    _tpl = '';
                                    $(".sl-time-day").hide();
                                    break;
                                default:
                                    _tpl = "";
                                    break;
                            }
                            $(".sl-time-day").append(_tpl);
                        })
                    }
                });
            },
            editEmail:function (obj) {
                var _data = $(obj).closest("tr").data("model");
                try{
                    if(typeof _data == "string"){
                        _data = $.parseJSON(_data);
                    }
                    this.openEmailModal(_data);
                }catch (e){
                    layer.msg("请求数据失败，请联系管理员");
                }
            },
            delEmail:function (esId,data,obj) {
                var _tpl = laytpl($("#delComConfirmEmail").html()).render(data);
                Email.confirm({
                    tpl:_tpl,
                    skin:'dialog-hm-del-wrap',
                    success:function (lay,idx) {
                        lay.find(".hdb-search-text").niceScroll({
                            /*autohidemode: false,*/  //是否总是显示
                            cursorcolor: "#bcd7e8",
                            railpadding: { top: 0, right: 1, left: 1, bottom: 0 }
                        });
                    },
                    ok:function (lay,idx) {
                        Email.ajax({
                            url:'/sales/flow/rmSubscription.html',
                            data:{esId: esId},
                            success:function (res) {
                                if(res && res.success){
                                    $(obj).closest("tr").remove();
                                    layer.msg("删除成功",{},function () {
                                        location.reload();
                                    });
                                }else{
                                    layer.msg("删除失败，请联系管理员");
                                }
                            },
                            error:function () {
                                layer.msg("删除失败，请联系管理员");
                            }
                        })
                    }
                })
            }
        }
        $(function () {

            $('body').addClass('hm-has-js');
            $('.label_check,.label_radio').click(function(){
                setupLabel();
            });
            setupLabel();

            $('#start_date').attr("disabled","disabled");
            $('#end_date').attr("disabled","disabled");
            $("input:radio[name=timeType]").change(function () {
                var selectedvalue = $("input[name='timeType']:checked").val();
                if(selectedvalue == '5'){
                    $('#start_date').removeAttr("disabled");
                    $('#end_date').removeAttr("disabled");
                }else{
                    $('#start_date').attr("disabled","disabled");
                    $('#end_date').attr("disabled","disabled");
                    $('#start_date').val("");
                    $('#end_date').val("");
                }
            });

            getEmailList(true,1);

            bindEmailEvt();

            $(".hqb-table").find("tr:last td").css("border-bottom","none");

            $(".th-pos").mouseenter(function () {
                $(this).find(".th-tips").show();
            });

            $(".th-pos").mouseleave(function () {
                $(this).find(".th-tips").hide();
            });

            findLocation(0,$(".hm-choice-province"));

            //省列表点击
            $(".hm-choice-province").on("click","li",function () {
                $(this).addClass("selected").siblings("li").removeClass("selected");
                var _pid = $(this).attr("data-id");
                if(_pid == -1){
                    $(".hm-choice-city").find("ul").html('<li data-id="0" class="selected"><a onclick="return false;" href="javascript:void(0);">全部市</a></li>');
                    $(".hm-choice-company").find("ul").html('<li data-id="0" class="selected"><a onclick="return false;" href="javascript:void(0);">全部商业公司</a></li>');
                    //findCompany("",$(".hm-choice-company"));
                }else{
                    $(".hm-choice-city").find("ul").html('<li data-id="0" ><a onclick="return false;" href="javascript:void(0);">全部市</a></li>');
                    $(".hm-choice-company").find("ul").html('');
                    findLocation($(this).attr("data-id"),$(".hm-choice-city"));
                }
            })
            //市列表点击
            $(".hm-choice-city").on("click","li",function () {
                $(this).addClass("selected").siblings("li").removeClass("selected");
                var _cid = $(this).attr("data-id");
                if(_cid == 0){
                    $(".hm-choice-company").find("ul").html('<li data-id="0" class="selected"><a onclick="return false;" href="javascript:void(0);">全部商业公司</a></li>');
                }else{
                    $(".hm-choice-company").find("ul").html('<li data-id="0"><a onclick="return false;" href="javascript:void(0);">全部商业公司</a></li>');
                    findCompany($(this).attr("data-id"),$(".hm-choice-company"));
                }
            })

            //结果列表/单纯列表 点击事件
            $(".result-list-box,.hm-choice-goods,.hm-choice-company").on("click","li",function (e) {
                var bCTRL = e.ctrlKey;
                if(bCTRL){
                    $(this).addClass("selected");
                }
                else $(this).addClass("selected").siblings("li").removeClass("selected");
            })

            //给所有列表初始化滚动条
            $(".hm-choice-box").each(function () {
                $(this).niceScroll({
                    /*autohidemode: false,*/  //是否总是显示
                    cursorcolor: "#bcd7e8",
                    railpadding: { top: 0, right: 1, left: 1, bottom: 0 }
                });
            })

            //公司增减事件
            $(".com-btn-box").on("click","a",function () {
                var _evt = $(this).attr("data-evt");
                if(_evt == "add"){//新增
                    var _prov = $(".hm-choice-province").find("li.selected");
                    var _city = $(".hm-choice-city").find("li.selected");
                    var _comps = $(".hm-choice-company").find("li.selected");
                    if(_prov.length && _city.length && _comps.length){
                        _comps.each(function (idx,_comp) {
                            _comp = $(_comp);
                            var _tmp = {
                                provinceId : _prov.attr("data-id"),
                                cityId : _city.attr("data-id"),
                                companyId : _comp.attr("data-id"),
                                cShowName : _prov.text() + "-" +_city.text() + "-" + _comp.text()
                            }
                            var _hasId = "comList"+_tmp.provinceId+""+_tmp.cityId+""+_tmp.companyId;
                            if( !$(".hm-choice-result ul").find("#"+_hasId).length){
                                $(".hm-choice-result ul").append('<li id="'+_hasId+'" data-result=\''+JSON.stringify(_tmp)+'\'><a onclick="return false;" href="javascript:void(0);">'+_tmp.cShowName+'</a></li>')
                            }else{
                                layer.msg("已添加此项，请勿重复添加");
                            }
                        })
                        _comps.removeClass("selected");
                    }else{
                        layer.msg("请先选择省、市及商业公司");
                    }
                }else{
                    var _selResCompany = $(".hm-choice-result ul").find("li.selected");
                    if(_selResCompany && _selResCompany.length){
                        _selResCompany.remove();
                    }else{
                        layer.msg("请先选择已添加的商业公司");
                    }
                }
            })

            //产品增减事件
            $(".cp-btn-box").on("click","a",function () {
                var _evt = $(this).attr("data-evt");
                if(_evt == "add"){//新增
                    var _drugSels = $(".hm-choice-goods ul").find("li.selected");
                    if(_drugSels && _drugSels.length){
                        _drugSels.each(function (i,_drugSel) {
                            _drugSel = $(_drugSel);
                            var _did = _drugSel.attr("data-id");
                            if(!$(".hm-choice-goods-result").find("#addDrug"+_did).length){
                                var _addDrugSel = _drugSel.clone();
                                _addDrugSel.attr("id","addDrug"+_did).removeClass("selected");
                                $(".hm-choice-goods-result ul").append(_addDrugSel);
                            }else{
                                layer.msg("已添加此项，请勿重复添加");
                            }
                        })
                        _drugSels.removeClass("selected");
                    }else{
                        layer.msg("请先选择产品");
                    }
                }else{
                    var _drugSel = $(".hm-choice-goods-result ul").find("li.selected");
                    if(_drugSel && _drugSel.length){
                        _drugSel.remove();
                    }else{
                        layer.msg("请先选择已添加的产品");
                    }
                }
                $(".hm-choice-goods-count").text("已添加："+$(".hm-choice-goods-result li").length)

            })

            //选择列表双击添加事件
            $(".hm-choice-company , .hm-choice-goods").on("dblclick","li",function () {
                $(this).addClass("selected").closest("tr").find("[data-evt='add']").get(0).click();
            })
            //结果列表双击删除事件
            $(".result-list-box").on("dblclick","li",function () {
                $(this).remove();
                $(".hm-choice-goods-count").text("已添加："+$(".hm-choice-goods-result li").length)
            })

        })
    })



    <!-- 自定义radio&checkbox -->
    function setupLabel(){
        if($('.label_check input').length) {
            $('.label_check').each(function(){
                $(this).removeClass('c_on');
            });
            $('.label_check input:checked').each(function(){
                $(this).parent('label').addClass('c_on');
            });
        }
        if($('.label_radio input').length) {
            $('.label_radio').each(function(){
                $(this).removeClass('r_on');
            });
            $('.label_radio input:checked').each(function(){
                $(this).parent('label').addClass('r_on');
            });
        }
    }


    /**
     * 星期转换
     */
    function getWeekDate(date) {
        if(date){
            var _week = ["一", "二", "三", "四", "五", "六", "日"];
            return "星期"+_week[date-1];
        }else return "";
    }

    function getEmailList(first,pi) {
        var _data = {
            pi : pi?pi:1,
            ps : ps
        }
        layer.load(0,{shade:.1});
        $.ajax({
            url: '/sales/flow/subscriptionPage.html',
            data: _data,
            type:"post",
            complete:function () {
                layer.closeAll("loading");
            },
            success: function(res) {
                if(res && res.data && res.data.list.length){
                    var _html = laytpl($("#emailListTpl").html()).render(res.data.list);
                    $("#emailListBox").html(_html);
                    var _pages = parseInt((res.data.pagerInfo.rowsCount+res.data.pagerInfo.pageSize-1)/res.data.pagerInfo.pageSize);
                    if(first){
                        laypage({
                            cont: $(".hm-page"),
                            pages: _pages, //总页数
                            groups: 7, //连续显示分页数,
                            skin:"#0f93ce",
                            jump: function(e, first){
                                if(!first){
                                    getEmailList(false,e.curr);
                                }
                            }
                        });
                    }
                    if(top && top.resetFrame) top.resetFrame();
                }else{
                    layer.msg(res.message?res.message:"暂无邮件订阅数据");
                }
            }
        });
    }

    /**
     * 绑定邮件操作事件
     */
    function bindEmailEvt() {
        $(".layer-add-mail-btn").unbind("click").on("click", function(){
            Email.openEmailModal();
        });

        $(".layer-delete-mail-btn").unbind("click").on("click", function(){
            layer.open({
                type: 1,
                skin: 'dialog-hm-wrap',
                title: false,
                closeBtn: 0,
                area: ['510px'], //宽高
                shadeClose: false, //开启遮罩关闭
                content: $(".layer-delete-mail-box"),
                success: function (lay, idx) {
                    $(lay).find(".layer-close-btn").on("click", function () {
                        layer.close(idx);
                    })
                }
            });
        });
    }

    /***
     * 获取已添加的商业公司 和 产品 列表数据
     * 数据结构：
     *  {
     *      company:[
     *          {
     *              companyId:[可选],
     *              provinceId:[可选],
     *              cityId:[可选],
     *           }
     *      ],
     *      drugs:['产品ID']
     * */
    function getCompanyAndDrugs() {
        var result = {
            company:[],
            drugs:[]
        }
        $(".hm-choice-result li").each(function () {
            var _tmp = $(this).attr("data-result");
            if(_tmp){
                _tmp = JSON.parse(_tmp);
                $.each(_tmp,function (i,e) {
                    if(e == "0"){
                        delete _tmp[i];
                    }
                })
                if(_tmp.companyId){
                    delete  _tmp["provinceId"] && delete _tmp["cityId"];
                }else if(_tmp.cityId){
                    delete  _tmp["provinceId"];
                }
                result.company.push(_tmp);
            }
        })

        $(".hm-choice-goods-result li").each(function () {
            var _did = $(this).attr("data-id");
            var _dname = $(this).attr("data-gName");
            var _dspc = $(this).attr("data-gSpecifications");
            if(_did){
                var _tmp = {
                    gId : _did,
                    gName : _dname,
                    gSpc : _dspc
                }
                result.drugs.push(_tmp);
            }
        })

        return result;
    }


    /**
     * 省市联动
     * @param lpId      上级ID
     * @param object    填充对象DOM
     */
    function findLocation(lpId,object){
        Email.ajax({
            url:'/location/provincialCity',
            data:{lpid: lpId},
            success:function (data) {
                if(data && data.data && data.data.length){
                    var location = data.data;
                    $.each(location,function (idx,o) {
                        $(object).find("ul").append('<li data-id="'+o.lid+'" data-model="'+JSON.stringify(o)+'"><a onclick="return false;" href="javascript:void(0);">'+o.lname+'</a></li>');

                    })
                }
            },
            error:function () {
                layer.msg("请求数据失败，请联系管理员");
            }
        })
    }

    function findCompany(cid,obj) {
        var _params = {
            provinceIds:"",
            cityIds:""
        }
        if(cid){
            var _pid = $(".hm-choice-province ul").find("li.selected").attr("data-id");
            if(_pid){
                _params = {
                    provinceIds : _pid,
                    cityIds : cid
                }
            }
        }
        Email.ajax({
            url:'/sales/flow/getFlowSuppliers.html',
            data:_params,
            success:function (data) {
                if(data){
                    var company = data.data;
                    if(company && company.length){
                        $.each(company,function (idx,o) {
                            $(obj).find("ul").append('<li data-tips="true" data-tips-style="{\'color\':\'#000\'}" data-tips-title="'+o.suName+'" data-id="'+o.suId+'" data-model="'+JSON.stringify(o)+'"><a onclick="return false;" href="javascript:void(0);">'+o.suName+'</a></li>');
                            bindTips();

                        })
                    }
                }
            },
            error:function () {
                layer.msg("请求数据失败，请联系管理员");
            }
        })

    }

    /***
     * 启动下载查询
     * @param   type    类型 1 ：保存，2：下载
     * @param   isShowText  填充历史搜索条件时的提示语 flag
     * @param   qcId    搜索条件的id
     * @param   obj     搜索条件的dom
     *
     */
    function downloadExc(type,isShowText , qcId , obj) {

        /*if(type ==1 && _backFillId){
            layer.msg("已保存过的搜索不能再次保存");
            return false;
        }*/

        var start_date = $("#table").find("input[name=start_date]:enabled").val();
        var end_date = $("#table").find("input[name=end_date]:enabled").val();
        var timeType=$('input:radio[name="timeType"]:checked').val();
        var jsonArry = getCompanyAndDrugs();
        var company = jsonArry.company;
        var drugs = jsonArry.drugs;
        var _qcDownloadType = [];
        $("[name=qcDownloadType]:checked").each(function () {
            _qcDownloadType.push($(this).val());
        })

        if(company==""){
            layer.msg("请选择商业公司");
            return;
        }
        if(drugs==""){
            layer.msg("请选择产品");
            return;
        }

        var paramJson = JSON.stringify(getCompanyAndDrugs());
        if(timeType == "5"){
            if(start_date==""){
                layer.msg("请选择开始时间");
                return;
            }
            if(end_date==""){
                layer.msg("请选择结束时间");
                return;
            }
            if(start_date>end_date){
                layer.msg("结束时间必须大于或等于开始时间");
                return;
            }
            var days = DateDiff(start_date, end_date);
            if(days>31){
                layer.msg("时间范围最大不能超过31天");
                return;
            }
        }

        if(!_qcDownloadType.length){
            layer.msg("请选择流向信息类型");
            return;
        }



        var sid = $("#sid").val();
        var _params = {
            start_date:start_date,
            end_date:end_date,
            timeType:timeType,
            paramJson:paramJson,
            qcName:'',
            sid:sid,
            qcDownloadType:_qcDownloadType.join(",")
        }

        if(type == '1'){
            layer.open({
                type: 1,
                skin: 'dialog-hm-wrap',
                title: false,
                closeBtn: 0,
                area: ['455px'], //宽高
                shadeClose: false, //开启遮罩关闭
                content: $(".layer-save-search-box"),
                success: function (lay, idx) {
                    var _inp = lay.find(".input");
                    var _errDom = lay.find(".hdhb-c-error");
                    _errDom.addClass("invisible");
                    _inp.val("");

                    $(lay).find(".layer-close-btn").on("click", function () {
                        layer.close(idx);
                    })
                    lay.find(".btn-confirm").unbind("click").on("click",function () {
                        if($.trim(_inp.val())){
                            _params.qcName =  $.trim(_inp.val());
                        }else{
                            _errDom.text("请输入搜索名称").removeClass("invisible");
                            return false;
                        }
                        Email.ajax({
                            url:'/sales/flow/saveCondition.html',
                            data:_params,
                            success:function (res) {
                                if(res && res.data == 0){
                                    _errDom.text("名字重复，换一个吧~").removeClass("invisible");
                                    return false;
                                }else if(res && res.data){
                                    layer.msg("保存成功");
                                    var _tpl = '<li><span onclick="backFill('+res.data+',this)" class="text" title="'+_params.qcName+'-0">'+_params.qcName+'-0</span><a href="javascript:void(0);" onclick="rmQuery('+res.data+',null,this)" class="btn-remove layer-search-btn"></a></li>'
                                    $(".hsb-ctn ul").append(_tpl);
                                    layer.close(idx);
                                }else{
                                    layer.msg("保存失败");
                                }
                            },
                            error:function () {
                                layer.msg("请求数据失败，请联系管理员");
                            }
                        })
                    })
                }
            });

        }
        if(type == '2'){
            if(timerDownload){
                layer.msg( timing + "秒后才能再次下载" );
                return false;
            }
            if(qcId) _params.qcId = qcId;
            Email.ajax({
                url:'/sales/flow/exportflow.html',
                data:_params,
                success:function (data) {
                    if(data){
                        layer.load(0,{shade:.1});
                        if(isShowText) layer.msg("已自动使用该搜索条件查询并下载");
                        if(obj){
                            var _t = $(obj).attr("title");
                            var _nt = _t.split("-")[0] + "-" , _newN = parseInt(_t.split("-")[1],0)+1;
                            $(obj).text(_nt+_newN).attr("title",_nt+_newN);
                        }
                        downFlow();
                        $("#downloadBtn").addClass("disable").text(timing+"秒后可再次下载");
                        timerDownload = setInterval(function () {
                            timing--;
                            if(!timing){
                                clearInterval(timerDownload);
                                timerDownload = null;
                                timing = 30;
                                $("#downloadBtn").removeClass("disable").text("查询并下载");
                                return false;
                            }
                            $("#downloadBtn").addClass("disable").text(timing+"秒后可再次下载");
                        },1000)
                    }else{
                        layer.msg("请求数据失败，请联系管理员");
                    }
                },
                error:function () {
                    layer.msg("请求数据失败，请联系管理员");
                }
            })
        }
    }

    function backFill(qcId,obj) {
        Email.ajax({
            url:'/sales/flow/queryCondition.html',
            data:{"qcId":qcId},
            success:function (res) {
                if(res && res.success){
                    var _model = res.data;
                    if(_model){
                        _backFillId = _model.qcId;
                        var _nrMap = _model.nrMap;
                        $(".hm-choice-goods-result").find("li").remove();
                        $("#start_date").val("");
                        $("#end_date").val("");
                        $.each(_nrMap,function (k,v) {
                            $(".hm-choice-goods").find("li[data-id="+k+"]").trigger("dblclick");
                        })
                        $("[name=timeType]").each(function () {
                            if($(this).val() == _model.qcTimeType){
                                $(this).prop("checked",true).parent().addClass("r_on");
                            }else{
                                $(this).removeAttr("checked").parent().removeClass("r_on");
                            }
                        })
                        if(_model.qcTimeType == 5){
                            $("#start_date").prop("disabled",false).val(new Date(_model.qcStartDate).format("yyyy-MM-dd"));
                            $("#end_date").prop("disabled",false).val(new Date(_model.qcEndDate).format("yyyy-MM-dd"));
                        }else{
                            $(".input-date","#form").prop("disabled","disabled");
                        }

                        if(_model.qcDownloadType){
                            var _tArr = _model.qcDownloadType.split(",");
                            $("[name=qcDownloadType]").each(function () {
                                if($.inArray($(this).val(),_tArr) > -1){
                                    $(this).prop("checked",true).parent().addClass("r_on");
                                }else{
                                    $(this).removeAttr("checked").parent().removeClass("r_on");
                                }
                            })
                        }

                        //回填省市及商业公司
                        $(".hm-choice-province li").removeClass("selected");
                        $(".hm-choice-city").find("li").remove();
                        $(".hm-choice-company").find("li").remove();
                        $(".hm-choice-result").find("li").remove();
                        if(_model.companyMapList){
                            $.each(_model.companyMapList,function (i,_tmp) {
                                var _provinceId = _tmp.provinceId = _tmp.provinceId?_tmp.provinceId:0 ,
                                        _cityId = _tmp.cityId = _tmp.cityId?_tmp.cityId:0 ,
                                        _companyId = _tmp.companyId = _tmp.companyId?_tmp.companyId:0 ,
                                        _desc = _tmp.desc;
                                /*if(i == (_model.companyMapList.length-1)){ //最后一条数据的省市选中状态
                                    if(_provinceId == -1){
                                        $(".hm-choice-province").find("li[data-id=-1]").trigger("click");
                                    }else{

                                    }
                                }*/
                                _tmp.cShowName = _tmp.desc;
                                var _hasId = "comList" + _provinceId + "" + _cityId+ "" + _companyId;
                                $(".hm-choice-result ul").append('<li id="'+_hasId+'" data-result=\''+JSON.stringify(_tmp)+'\'><a onclick="return false;" href="javascript:void(0);">'+_desc+'</a></li>')
                            })
                        }

                        /*回填完毕后激活下载*/
                        downloadExc(2,true,qcId,obj);
                    }
                }
            },
            error:function () {
                layer.msg("请求数据失败，请联系管理员");
            }
        })
    }

    function downFlow(){
        $("#form").attr("action", "/sales/flow/downflow.html");
        $("#form").submit();
        layer.closeAll("loading");
    }

    function DateDiff(startDate, endDate) {  //sDate1和sDate2是yyyy-MM-dd格式
        var startTime = new Date(Date.parse(startDate.replace(/-/g,   "/"))).getTime();
        var endTime = new Date(Date.parse(endDate.replace(/-/g,   "/"))).getTime();
        var dates = Math.abs((startTime - endTime))/(1000*60*60*24);
        return  dates;
    }

    function rmQuery(qcId,option,obj){

        Email.ajax({
            url:'/sales/flow/rmQueryCondition.html',
            data:{"qcId":qcId,"option":option},
            success:function (data) {
                var type = data.data.type;
                if(type == 0){
                    var _tpl1 = laytpl($("#delConConfirmTpl").html()).render({
                        name:$(obj).prev().text(),
                        count:data.data.count,
                        msg:data.data.msg
                    })
                    Email.confirm({
                        tpl: _tpl1,
                        ok: function (lay1, idx1) {
                            Email.ajax({
                                url: '/sales/flow/rmQueryCondition.html',
                                data: {"qcId": qcId, "option": "del"},
                                success: function (data) {
                                    if (data && data.success) {
                                        layer.close(idx1);
                                        $(obj).closest("li").remove();
                                        layer.msg("已删除");
                                    } else {
                                        layer.msg("删除失败，请联系管理员");
                                    }
                                }, error: function () {
                                    layer.msg("删除失败，请联系管理员");
                                }
                            })
                        }
                    })

                }else if(type == 1){
                    var _tpl = laytpl($("#delConfirm").html()).render({name:$(obj).prev().text()})
                    Email.confirm({
                        tpl:_tpl,
                        ok:function (lay,idx) {
                            Email.ajax({
                                url: '/sales/flow/rmQueryCondition.html',
                                data: {"qcId": qcId, "option": "del"},
                                success: function (data) {
                                    if (data && data.success) {
                                        layer.close(idx);
                                        $(obj).closest("li").remove();
                                        layer.msg("已删除");
                                    } else {
                                        layer.msg("删除失败，请联系管理员");
                                    }
                                }, error: function () {
                                    layer.msg("删除失败，请联系管理员");
                                }
                            })

                        }
                    })

                }
            }
        })

    }

</script>
</body>
</html>